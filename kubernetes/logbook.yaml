---

apiVersion: v1
kind: Service
metadata:
  name: auth
spec:
  ports:
  - port: 443
    targetPort: 443
  selector:
    name: auth


---

kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: ${namespace}-expdata-${environment}
spec:
  storageClassName: ${namespace}-expdata-${environment}
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 1Gi


---


kind: ConfigMap
metadata:
  name: auth-explgbk-config
apiVersion: v1
data:
  explgbk.conf: |-
    # prevent .htaccess and .htpasswd files from being viewed by Web clients.
    <Files ".ht*">
        Require all denied
    </Files>

    # LogLevel: Control the number of messages logged to the error_log.
    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    #turn on url rewriting
    RewriteEngine on

    AddType application/x-pkcs7-crl    .crl
    SSLPassPhraseDialog  builtin
    SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
    SSLSessionCacheTimeout  300
    #SSLMutex default
    SSLRandomSeed startup file:/dev/urandom  256
    SSLRandomSeed connect builtin
    SSLCryptoDevice builtin

    # FAKE AUTH SETTINGS
    #SetEnv REMOTE_USER someone
    #SetEnv WEBAUTH_USER someone
    #SetEnv AUTH_TYPE WebAuth
    #SetEnv WEBAUTH_TOKEN_CREATION 1000000000
    #SetEnv WEBAUTH_TOKEN_EXPIRATION 2000000000
    #SetEnv WEBAUTH_FACTORS_INITIAL p
    #SetEnv WEBAUTH_FACTORS_SESSION p

    NameVirtualHost *:80
    <VirtualHost *:80>
        # ServerAdmin admin@localhost.com
        # ServerName localhost
        Redirect permanent / https://localhost/
    </VirtualHost>

    <VirtualHost *:443>
        # ServerAdmin admin@localhost.com
        # ServerName localhost
        SSLEngine on
        SSLProtocol all -SSLv2
    #    SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
        SSLCipherSuite ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:RC4+RSA:+HIGH:+MEDIUM
        #SSLCertificateChainFile /etc/httpd/conf/ssl/IntermediateCA.crt
        SSLCertificateFile /etc/httpd/certs/cert.crt
        SSLCertificateKeyFile /etc/httpd/certs/cert.key

        LogLevel    info
        ErrorLog    /dev/stderr
        CustomLog   /dev/stdout combined

        WebAuthCredCacheDir conf/webauth/credcache/
        # WebAuthDebug on

        #<Proxy *>
        #    Order deny,allow
        #    Allow from all
        #</Proxy>

        <LocationMatch "^/lgbk_socketio/(.*)$">
            RequestHeader set REMOTE_USER "%{REMOTE_USER}e"
            ProxyPass ws://explgbk:8000/$1
            ProxyPassReverse ws://explgbk:8000/$1
        </LocationMatch>

        <LocationMatch "^/(?<yyyymm>[^/]+)/(?<expname>[^_]+)_TEM(?<tem>\d)/(?<filepath>.*)$">
            LogMessage "RAW REQUEST"
            SSLOptions +StdEnvVars
            WebAuthExtraRedirect on
            AuthType WebAuth
            require valid-user
            Alias "/expdata/%{env:MATCH_YYYYMM}/%{env:MATCH_EXPNAME}_TEM%{env:MATCH_TEM}/%{env:MATCH_FILEPATH}"
            SetEnvIf Cookie "LGBK_EXT_PREVIEW=([^;]+)" HASHED_PREVIEW_COOKIE=$1
            Require expr "%{base64:%{md5:%{reqenv:MATCH_EXPNAME}SLACExpLgBk}} == %{unescape:%{reqenv:HASHED_PREVIEW_COOKIE}}"
        </LocationMatch>

        <Location "/cryoem-data/">
            SSLOptions +StdEnvVars
            AuthType Basic
            AuthName "Authentication Required"
            AuthUserFile "/etc/httpd/certs/backend.htpasswd"
            require valid-user
            RequestHeader set REMOTE_USER "%{REMOTE_USER}s"
            ProxyPass  http://explgbk:8000/
            ProxyPassReverse  http://explgbk:8000/
        </Location>

        # use prefix here
        <Location "/lgbk/">
            SSLOptions +StdEnvVars
            # RewriteEngine On
            WebAuthExtraRedirect on
            AuthType WebAuth
            require valid-user
            RequestHeader set REMOTE_USER "%{REMOTE_USER}s"
            ProxyPass  http://explgbk:8000/lgbk/
            ProxyPassReverse  http://explgbk:8000/lgbk/
        </Location>
        <Location "/js/">
            SSLOptions +StdEnvVars
            # RewriteEngine On
            RequestHeader set REMOTE_USER "%{REMOTE_USER}s"
            ProxyPass  http://explgbk:8000/js/
            ProxyPassReverse  http://explgbk:8000/js/
        </Location>
        <Location "/static/">
            SSLOptions +StdEnvVars
            # RewriteEngine On
            RequestHeader set REMOTE_USER "%{REMOTE_USER}s"
            ProxyPass  http://explgbk:8000/static/
            ProxyPassReverse  http://explgbk:8000/static/
        </Location>

        SetEnvIf User-Agent ".*MSIE.*" \
             nokeepalive ssl-unclean-shutdown \
             downgrade-1.0 force-response-1.0

    </VirtualHost>


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth
spec:
  replicas: 1
  selector:
    matchLabels:
      name: auth
  minReadySeconds: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        name: auth
    spec:
      nodeSelector:
$(list=(${logbook_auth__nodeSelectors// / }); for k in "${!list[@]}"; do kv=(${list[k]//\=/ }); echo "        ${kv[0]}: ${kv[1]}"; done)
      containers:
        - name: auth
          image: slaclab/explgbk-auth:${logbook_auth__tag}
          ports:
            - containerPort: 443
          env:
            # - name: FAKE_AUTH
            #   value: "1"
            # - name: FAKE_AUTH_USER
            #   value: "ytl"
            - name: REQUIRE_VALID_USER
              value: "1"
            - name: USE_WEBAUTH
              value: "1"
            ###
            # server
            ###
            - name: SERVER_NAME
              value: ${logbook_url}
            - name: SERVER_ADMIN
              value: ${logbook_admin}
            - name: PROXY_HOST
              value: explgbk
            - name: HTTPS_REDIRECT
              value: https://${logbook_url}/
          volumeMounts:
            - name: auth-secrets
              mountPath: /etc/httpd/certs/
            - name: auth-exp-data
              mountPath: /expdata/
            - name: auth-configmap
              mountPath: /etc/httpd/conf.d/explgbk.conf
              subPath: explgbk.conf
      volumes:
        - name: auth-secrets
          secret:
            secretName: auth-secrets
            items:
              - key: cert.crt
                path: cert.crt
              - key: cert.key
                path: cert.key
              - key: keytab_webauth
                path: keytab_webauth
              - key: backend.htpasswd
                path: backend.htpasswd
        - name: auth-exp-data
          persistentVolumeClaim:
            claimName: ${namespace}-expdata-${environment}
        - name: auth-configmap
          configMap:
            name: auth-explgbk-config
            items:
              - key: explgbk.conf
                path: explgbk.conf
              

---

apiVersion: v1
kind: Service
metadata:
  name: explgbk
  labels:
    name: explgbk
spec:
  ports:
  - port: 8000
    targetPort: 8000
  selector:
    name: explgbk


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: explgbk
spec:
  replicas: 2
  selector:
    matchLabels:
      name: explgbk
  minReadySeconds: 30
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        name: explgbk
    spec:
      nodeSelector:
$(list=(${logbook_explgbk__nodeSelectors// / }); for k in "${!list[@]}"; do kv=(${list[k]//\=/ }); echo "        ${kv[0]}: ${kv[1]}"; done)
      containers:
      - name: explgbk
        image: slaclab/explgbk-docker:${logbook_explgbk__tag}
        ports:
          - containerPort: 8000
        env:
          - name: LOGBOOK_SITE
            value: ${logbook_site}
          - name: URAWI_EXPERIMENT_LOOKUP_URL
            value: ${logbook_urawi_endpoint}
          - name: NODE_ENV
            value: ${environment}
          - name: MONGODB_HOST
            value: mongo
          - name: MONGODB_PORT
            value: "27017"
          - name: MONGODB_ADMIN_USERNAME
            valueFrom:
              secretKeyRef:
                name: explgbk-writer
                key: username
          - name: MONGODB_ADMIN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: explgbk-writer
                key: password
          - name: MONGODB_USERNAME
            valueFrom:
              secretKeyRef:
                name: explgbk-writer
                key: username
          - name: MONGODB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: explgbk-writer
                key: password
          - name: ROLES_DATABASE_HOST
            value: mongodb
          - name: ROLES_DATABASE_USER
            valueFrom:
              secretKeyRef:
                name: explgbk-reader
                key: username
          - name: ROLES_DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: explgbk-reader
                key: password
          - name: KAFKA_BOOTSTRAP_SERVER
            value: kafka:9092



---
  
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: www
  annotations:
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  rules:
    - host: ${logbook_url}
      http:
        paths:
        - path: /
          backend:
            serviceName: auth
            servicePort: 443
            
            
---
  
#apiVersion: v1
#kind: ReplicationController
#metadata:
#  name: kafka-test
#spec:
#  replicas: 1
#  selector:
#    name: kafka-test
#  template:
#    metadata:
#      labels:
#        name: kafka-test
#    spec:
#      nodeSelector:
#        group: cryoem
#      containers:
#      - name: kafka-test
#        image: slaclab/kafka-consumer:latest
#        ports:
#          - containerPort: 8000
#        env:
#          - name: KAFKA_BOOTSTRAP_SERVER
#            value: kafka:9092
